{% extends 'library/base.html' %}

{% block title %}{{ title|default:"Add Book" }} - Library Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <div class="container-fluid">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2 text-white">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}" class="text-white-50">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'book_list' %}" class="text-white-50">Books</a></li>
                    <li class="breadcrumb-item active text-white">Add Book</li>
                </ol>
            </nav>
            <h1 class="mb-0">
                <i class="bi bi-plus-circle"></i> {{ title|default:"Add New Book" }}
            </h1>
            <p class="mb-0 mt-2">Add a new book to your library collection</p>
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        <div class="row">
            <!-- Main Book Information -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i> Book Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Title -->
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    <i class="bi bi-book"></i> Book Title <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.title.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- ISBN -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.isbn.id_for_label }}" class="form-label">
                                    <i class="bi bi-upc-scan"></i> ISBN <span class="text-danger">*</span>
                                </label>
                                {{ form.isbn }}
                                {% if form.isbn.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.isbn.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">10 or 13 digit ISBN</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Publisher -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.publisher.id_for_label }}" class="form-label">
                                    <i class="bi bi-building"></i> Publisher <span class="text-danger">*</span>
                                </label>
                                {{ form.publisher }}
                                {% if form.publisher.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.publisher.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Published Date -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.published_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar"></i> Published Date <span class="text-danger">*</span>
                                </label>
                                {{ form.published_date }}
                                {% if form.published_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.published_date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Total Copies -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.total_copies.id_for_label }}" class="form-label">
                                    <i class="bi bi-stack"></i> Total Copies <span class="text-danger">*</span>
                                </label>
                                {{ form.total_copies }}
                                {% if form.total_copies.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.total_copies.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Available Copies -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.available_copies.id_for_label }}" class="form-label">
                                    <i class="bi bi-check-circle"></i> Available Copies
                                </label>
                                {{ form.available_copies }}
                                {% if form.available_copies.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.available_copies.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Leave blank to default to total copies</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-tags"></i> Categories
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Existing Categories -->
                        <label class="form-label">Select Categories:</label>
                        <div class="row">
                            {% for choice in form.category %}
                                <div class="col-md-4 col-sm-6 mb-2">
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="col-12">
                                    <p class="text-muted mb-0">No categories available. Create new ones below.</p>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Add New Categories -->
                        <hr class="my-3">
                        <div class="row">
                            <div class="col-12">
                                <label for="{{ form.new_categories.id_for_label }}" class="form-label">
                                    <i class="bi bi-plus-circle"></i> {{ form.new_categories.label }}
                                </label>
                                {{ form.new_categories }}
                                <div class="form-text">{{ form.new_categories.help_text }}</div>
                                {% if form.new_categories.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.new_categories.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Author Information Sidebar -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person"></i> Author Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Existing Author Selection -->
                        <div class="mb-3">
                            <label for="{{ form.author.id_for_label }}" class="form-label">
                                Select Existing Author:
                            </label>
                            {{ form.author }}
                            {% if form.author.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.author.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Divider -->
                        <div class="text-center my-3">
                            <span class="badge bg-light text-dark">OR</span>
                        </div>

                        <!-- New Author Creation -->
                        <div class="mb-3">
                            <label for="{{ form.new_author_name.id_for_label }}" class="form-label">
                                <i class="bi bi-person-plus"></i> {{ form.new_author_name.label }}
                            </label>
                            {{ form.new_author_name }}
                            {% if form.new_author_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.new_author_name.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.new_author_biography.id_for_label }}" class="form-label">
                                {{ form.new_author_biography.label }}
                            </label>
                            {{ form.new_author_biography }}
                            {% if form.new_author_biography.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.new_author_biography.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning"></i> Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Add Book
                            </button>
                            <a href="{% url 'book_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel & Go Back
                            </a>
                        </div>
                        
                        <!-- Form Help -->
                        <hr class="my-3">
                        <div class="small text-muted">
                            <h6 class="text-dark">Quick Tips:</h6>
                            <ul class="mb-0 ps-3">
                                <li>Fields marked with <span class="text-danger">*</span> are required</li>
                                <li>ISBN should be 10 or 13 digits</li>
                                <li>Available copies will default to total copies if not specified</li>
                                <li>You can either select an existing author or create a new one</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Errors -->
        {% if form.non_field_errors %}
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle"></i> Please fix the following errors:</h6>
                        {{ form.non_field_errors }}
                    </div>
                </div>
            </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .invalid-feedback {
        display: block;
    }
    
    .card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
        .card-body {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-sync available copies with total copies
    document.getElementById('id_total_copies').addEventListener('input', function() {
        const totalCopies = this.value;
        const availableCopiesField = document.getElementById('id_available_copies');
        
        if (totalCopies && !availableCopiesField.value) {
            availableCopiesField.placeholder = `Default: ${totalCopies}`;
        }
    });
    
    // Clear author selection when typing new author name
    document.getElementById('id_new_author_name').addEventListener('input', function() {
        if (this.value) {
            document.getElementById('id_author').value = '';
        }
    });
    
    // Clear new author name when selecting existing author
    document.getElementById('id_author').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('id_new_author_name').value = '';
            document.getElementById('id_new_author_biography').value = '';
        }
    });
    
    // Form validation feedback
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('.form-control, .form-select');
        
        inputs.forEach(input => {
            input.addEventListener('invalid', function() {
                this.classList.add('is-invalid');
            });
            
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
                if (this.checkValidity()) {
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                }
            });
        });
    });
</script>
{% endblock %}